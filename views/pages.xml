<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <!-- TEMPLATE (debe ir antes de usarlo en website.page) -->
        <template id="portal_facturacion_page_view" name="Portal Facturación Página">
            <t t-call="website.layout">
                <div class="container mt-4">

                    <h1>Portal de Facturación</h1>

                    <!-- FORMULARIO -->
                    <form action="/portal/facturacion/buscar" method="post">

                        <div class="form-group mt-3">
                            <label>Ingrese su número de pedido:</label>
                            <input type="text" name="order_number" class="form-control" required="required"/>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            Buscar
                        </button>

                    </form>

                </div>
            </t>
        </template>

        <template id="portal_facturacion_no_encontrado" name="Pedido No Encontrado">
            <t t-call="website.layout">
                <div class="container mt-4">
                    <h2>No se ha encontrado ningún pedido</h2>
                    <p>
                        No se encontró ningún pedido con el número:
                        <strong><t t-esc="numero"/></strong>
                    </p>

                    <a href="/portal/facturacion" class="btn btn-secondary mt-3">
                        Regresar
                    </a>
                </div>
            </t>
        </template>

        <template id="portal_facturacion_identificar_cliente" name="Identificación de Cliente CFDI">
            <t t-call="website.layout">
                <div class="container mt-4">
                    <h1>Facturación CFDI</h1>
                    <h3>Pedido: <t t-esc="order.pos_reference"/></h3>

                    <div class="alert alert-info" role="alert">
                        Para iniciar su facturación, ingrese su **Registro Federal de Contribuyentes (RFC)**.
                    </div>

                    <form action="/portal/facturacion/procesar_rfc" method="post">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <input type="hidden" name="order_id" t-att-value="order.id"/>

                        <div class="form-group mt-3">
                            <label for="rfc">RFC (Registro Federal de Contribuyentes)</label>
                            <input type="text" name="rfc" id="rfc" class="form-control" required="required" 
                                placeholder="Ej: XXXX000000XXX" 
                                title="Ingrese su RFC completo."/>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            Continuar Facturación
                        </button> 
                        
                        <a href="/portal/facturacion" class="btn btn-secondary mt-3 ml-2">
                            Cancelar y buscar otro pedido
                        </a>
                    </form>

                </div>
            </t>
        </template>
    

        <template id="portal_facturacion_detalle" name="Detalle Factura">
            <t t-call="website.layout">
                <div class="container mt-4">
                    <h1>Comprobante Fiscal Digital</h1>

                    <!-- Agregar overlay de carga (oculto inicialmente) -->
                    <div id="loading-overlay" style="
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 9999;
                        color: white;
                        text-align: center;
                        padding-top: 20%;
                    ">
                        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <h3 class="mt-3">Generando su factura, por favor espere...</h3>
                    </div>

                    <form action="/portal/facturacion/crear_factura" method="post">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <div class="form-group mt-3">

                            <input type="hidden" name="order_id" t-att-value="order.id"/>

                            <label for="company_name">Razón social:</label>
                            <input type="text" name="company_name" id="company_name" class="form-control" required="required"
                                t-att-value="partner and partner.name or ''" />

                            <label for="r_f_C">R.F.C:</label>
                            <input type="text" name="r_f_C" id="r_f_C" class="form-control" required="required"
                                t-att-value="partner and partner.vat or ''" 
                                t-att-readonly="'readonly' if partner else None"/>

                            <label for="zip">Código postal</label>
                            <input type="text" name="zip" id="zip" class="form-control"
                                t-att-value="partner and partner.zip or ''" />

                            <label for="street">Calle</label>
                            <input type="text" name="street" id="street" class="form-control"
                                t-att-value="partner and partner.street or ''" />

                            <label for="ext">Ext</label>
                            <input type="text" name="ext" id="ext" class="form-control" />

                            <label for="int">Int</label>
                            <input type="text" name="int" id="int" class="form-control" />

                            <label for="cologne">Colonia</label>
                            <input type="text" name="cologne" id="cologne" class="form-control" />

                            <label for="city">Ciudad</label>
                            <input type="text" name="city" id="city" class="form-control" required="required"
                                t-att-value="partner and partner.city or ''" />

                            <label for="state_id">Estado</label>
                            <select name="state_id" id="state_id" class="form-control" required="required">
                                <option value="">Seleccione un estado</option>
                                <t t-foreach="states" t-as="s">
                                    <option t-att-value="s.id" t-att-selected="partner and partner.state_id and s.id == partner.state_id.id">
                                        <t t-esc="s.name"/>
                                    </option>
                                </t>
                            </select>

                            <label for="country_id">País</label>
                            <select name="country_id" id="country_id" class="form-control" required="required">
                                <option value="">Seleccione un país</option>
                                <t t-foreach="countries" t-as="c">
                                    <option t-att-value="c.id" t-att-selected="partner and partner.country_id and c.id == partner.country_id.id">
                                        <t t-esc="c.name"/>
                                    </option>
                                </t>
                            </select>


                            <label for="l10n_mx_edi_usage">Uso de CFDI</label>
                            <select name="l10n_mx_edi_usage" id="l10n_mx_edi_usage" class="form-control" required="required">
                                <option value="">Seleccione un uso de CFDI</option>
                                <t t-foreach="cfdi_usage_options" t-as="usage">
                                    <option t-att-value="usage[0]">
                                        <t t-esc="usage[0]"/> - <t t-esc="usage[1]"/>
                                    </option>
                                </t>
                            </select>

                            <!-- <label for="payment_method_id">Forma de pago</label>
                            <select name="payment_method_id" id="payment_method_id" class="form-control" required="required">
                                <option value="">Seleccione un metodo de pago</option>
                                <t t-foreach="payment_method" t-as="p">
                                    <option t-att-value="p.id">
                                        <t t-esc="p.name"/>
                                    </option>
                                </t>
                            </select> -->

                            <label for="l10n_mx_edi_fiscal_regime">Regimen fiscal</label>
                            <select name="l10n_mx_edi_fiscal_regime" id="l10n_mx_edi_fiscal_regime" class="form-control" required="required">
                                <option value="">Seleccione un regimen fiscal</option>
                                <t t-foreach="fiscal_regime_usage_options" t-as="f">
                                    <option t-att-value="f[0]" 
                                            t-att-selected="partner and partner.l10n_mx_edi_fiscal_regime and f[0] == partner.l10n_mx_edi_fiscal_regime">
                                        <t t-esc="f[0]"/> - <t t-esc="f[1]"/>
                                    </option>
                                </t>
                            </select>

                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            Crear factura
                        </button>    
                    </form>

                    <a href="/portal/facturacion" class="btn btn-secondary mt-4">
                        Buscar otro pedido
                    </a>

                    <!-- Script para mostrar loader al enviar formulario -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var form = document.getElementById('factura-form');
                            var loadingOverlay = document.getElementById('loading-overlay');
                            var submitBtn = document.getElementById('submit-btn');
                            
                            form.addEventListener('submit', function(e) {
                                // Mostrar loader
                                loadingOverlay.style.display = 'block';
                                
                                // Deshabilitar botón para evitar doble clic
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = 'Procesando...';
                                
                                // El formulario se enviará normalmente
                            });
                        });
                    </script>

                </div>
            </t>
        </template>


        <!-- REGISTRO DE LA PÁGINA WEBSITE -->
        <record id="portal_facturacion_page" model="website.page">
            <field name="name">Portal Facturación</field>
            <field name="url">/portal/facturacion</field>
            <field name="website_published">true</field>
            <field name="view_id" ref="portal_facturacion.portal_facturacion_page_view"/>
        </record>

    </data>
</odoo>
